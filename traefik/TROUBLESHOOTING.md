# Устранение проблем с сертификатами Traefik

Если у вас возникают проблемы с получением сертификатов Let's Encrypt в Traefik, воспользуйтесь этим руководством.

## Типичные причины проблем с сертификатами

1. **DNS не настроен правильно**
   - Ваш домен должен указывать на публичный IP-адрес сервера
   - Проверьте через `dig +short ваш-домен.com` или `nslookup ваш-домен.com`

2. **Порт 80 недоступен**
   - Для HTTP Challenge порт 80 должен быть доступен из интернета
   - Проверьте настройки файрвола и проксирования

3. **Неправильные права доступа**
   - Файл `acme.json` должен иметь права 600
   - Исправьте командой: `chmod 600 certs/acme.json`

4. **Проблемы с конфигурацией Traefik**
   - Ошибки в конфигурационных файлах
   - Несовпадение меток и имен доменов

## Пошаговая инструкция

### 1. Проверка DNS и доменов

```bash
# Проверка соответствия IP и домена
dig +short traefik.guide-it.ru
curl -s ifconfig.me
```

Убедитесь, что результаты совпадают.

### 2. Проверка доступности портов

```bash
# На сервере
netstat -tuln | grep -E ":80|:443"

# Извне (с другого компьютера)
curl -v http://traefik.guide-it.ru
```

Порты 80 и 443 должны быть доступны и не заблокированы файрволом.

### 3. Проверка прав доступа к файлу acme.json

```bash
stat -c %a certs/acme.json
```

Результат должен быть `600`.

### 4. Просмотр логов Traefik

```bash
docker compose logs -f traefik
```

Ищите ошибки, связанные с сертификатами, ACME, TLS.

### 5. Ручной сброс сертификатов

Используйте скрипт `reset-certs.sh`:

```bash
chmod +x reset-certs.sh
./reset-certs.sh
```

или выполните команды вручную:

```bash
docker compose down
rm -f certs/acme.json
touch certs/acme.json
chmod 600 certs/acme.json
docker compose up -d
```

### 6. Временное использование HTTP

Если вы не можете решить проблему с сертификатами, временно используйте HTTP:

1. В `traefik.yml` удалите или закомментируйте раздел `certificatesResolvers`.
2. Измените все `middlewares` и `labels` в Docker Compose на порт 80 и entryPoint `web`.

## Проверка получения сертификатов

После внесения изменений проверьте логи на наличие получения сертификатов:

```bash
docker compose logs -f traefik | grep -i "certificate\|acme\|challenge"
```

Успешное получение сертификата отобразится примерно так:
```
traefik    | time="2023-04-01T12:34:56Z" level=info msg="Certificate obtained successfully"
```

## Дополнительная проверка

Запустите скрипт диагностики:

```bash
chmod +x check-cert.sh
./check-cert.sh
```

Он выполнит все необходимые проверки и покажет рекомендации. 